\documentclass[tikz]{standalone}
\input{figures/common/preamble}

\begin{document}
\begin{tikzpicture}

\input{figures/common/dof_colors.tikz}

% define colors
\newcommand{\celldofcolor}{celldofcolor}
\newcommand{\edgedofcolor}{edgedofcolor}
\newcommand{\vertdofcolor}{vertdofcolor}

% draw the mesh
\begin{scope}[scale=1.2]
  % styles specific to the mesh
  \tkzSetUpStyle[draw=black,line width=.5]{edge}
  \tkzSetUpStyle[line width=1]{dof}
  \tkzSetUpStyle[dof,draw=\celldofcolor,fill=\celldofcolor]{celldof}
  \tkzSetUpStyle[dof,draw=\edgedofcolor,fill=\edgedofcolor]{edgedof}
  \tkzSetUpStyle[dof,draw=\vertdofcolor,fill=\vertdofcolor]{vertdof}

  % macros
  \newcommand{\defcellmidpoint}[4]{
    \tkzDefBarycentricPoint(#1=1,#2=1,#3=1) \tkzGetPoint{#4}
  }

  \newcommand{\drawcelldof}[3]{
    \defcellmidpoint{#1}{#2}{#3}{#1#2#3}
    \tkzDrawPoint[celldof](#1#2#3)
  }

  \newcommand{\drawedgedof}[2]{
    \tkzDefBarycentricPoint(#1=2,#2=1) \tkzGetPoint{#1#2}
    \tkzDefBarycentricPoint(#1=1,#2=2) \tkzGetPoint{#2#1}
    \tkzDrawPoint[edgedof](#1#2)
    \tkzDrawPoint[edgedof](#2#1)
  }

  \newcommand{\drawvertexdof}[1]{
    \tkzDrawPoint[vertdof](#1)
  }

  % define nodes
  \tkzDefPoints{0/0/v0,0/1/v1,0/2/v2,0/3/v3}
  \tkzDefPoints{1/0/v4,1/1/v5,1/2/v6, 1/3/v7}
  \tkzDefPoints{2/0/v8,2/1/v9,2/2/v10,2/3/v11}
  \tkzDefPoints{3/0/v12,3/1/v13,3/2/v14,3/3/v15}

  % make it look messy
  \tkzDefShiftPoint[v0](0,0){v0}
  \tkzDefShiftPoint[v1](0,.1){v1}
  \tkzDefShiftPoint[v2](-.1,-.1){v2}
  \tkzDefShiftPoint[v3](.2,.1){v3}
  \tkzDefShiftPoint[v4](.1,0){v4}
  \tkzDefShiftPoint[v5](0,0){v5}
  \tkzDefShiftPoint[v6](-.1,0){v6}
  \tkzDefShiftPoint[v7](0,0){v7}
  \tkzDefShiftPoint[v8](0,0){v8}
  \tkzDefShiftPoint[v9](.1,0){v9}
  \tkzDefShiftPoint[v10](0,.1){v10}
  \tkzDefShiftPoint[v11](-.1,.2){v11}
  \tkzDefShiftPoint[v12](0,-.1){v12}
  \tkzDefShiftPoint[v13](.1,-.1){v13}
  \tkzDefShiftPoint[v14](.2,.1){v14}
  \tkzDefShiftPoint[v15](.1,.1){v15}

  % draw the mesh
  \tkzDrawSegments[edge](v0,v1 v1,v2 v2,v3)
  \tkzDrawSegments[edge](v4,v5 v5,v6 v6,v7)
  \tkzDrawSegments[edge](v8,v9 v9,v10 v10,v11)
  \tkzDrawSegments[edge](v12,v13 v13,v14 v14,v15)
  \tkzDrawSegments[edge](v0,v4 v4,v8)
  \tkzDrawSegments[edge](v1,v5 v5,v9)
  \tkzDrawSegments[edge](v2,v6 v6,v10)
  \tkzDrawSegments[edge](v3,v7 v7,v11 v11,v15)
  \tkzDrawSegments[edge](v8,v12 v9,v13 v10,v14)
  \tkzDrawSegments[edge](v1,v4 v1,v6 v3,v6)
  \tkzDrawSegments[edge](v4,v9 v5,v10 v7,v10)
  \tkzDrawSegments[edge](v9,v12 v9,v14 v10,v15)

  % cell DoFs
  \drawcelldof{v0}{v1}{v4}
  \drawcelldof{v1}{v4}{v5}
  \drawcelldof{v1}{v5}{v6}
  \drawcelldof{v1}{v2}{v6}
  \drawcelldof{v2}{v3}{v6}
  \drawcelldof{v3}{v6}{v7}
  \drawcelldof{v4}{v8}{v9}
  \drawcelldof{v4}{v5}{v9}
  \drawcelldof{v5}{v9}{v10}
  \drawcelldof{v5}{v6}{v10}
  \drawcelldof{v6}{v7}{v10}
  \drawcelldof{v7}{v10}{v11}
  \drawcelldof{v8}{v9}{v12}
  \drawcelldof{v9}{v12}{v13}
  \drawcelldof{v9}{v13}{v14}
  \drawcelldof{v9}{v10}{v14}
  \drawcelldof{v10}{v14}{v15}
  \drawcelldof{v10}{v11}{v15}

  % edge DoFs
  \drawedgedof{v0}{v1}
  \drawedgedof{v1}{v2}
  \drawedgedof{v2}{v3}
  \drawedgedof{v4}{v5}
  \drawedgedof{v5}{v6}
  \drawedgedof{v6}{v7}
  \drawedgedof{v8}{v9}
  \drawedgedof{v9}{v10}
  \drawedgedof{v10}{v11}
  \drawedgedof{v12}{v13}
  \drawedgedof{v13}{v14}
  \drawedgedof{v14}{v15}
  \drawedgedof{v0}{v4}
  \drawedgedof{v4}{v8}
  \drawedgedof{v1}{v5}
  \drawedgedof{v5}{v9}
  \drawedgedof{v2}{v6}
  \drawedgedof{v6}{v10}
  \drawedgedof{v3}{v7}
  \drawedgedof{v7}{v11}
  \drawedgedof{v11}{v15}
  \drawedgedof{v8}{v12}
  \drawedgedof{v9}{v13}
  \drawedgedof{v10}{v14}
  \drawedgedof{v1}{v4}
  \drawedgedof{v1}{v6}
  \drawedgedof{v3}{v6}
  \drawedgedof{v4}{v9}
  \drawedgedof{v5}{v10}
  \drawedgedof{v7}{v10}
  \drawedgedof{v9}{v12}
  \drawedgedof{v9}{v14}
  \drawedgedof{v10}{v15}

  % vertex DoFs
  \drawvertexdof{v0}
  \drawvertexdof{v1}
  \drawvertexdof{v2}
  \drawvertexdof{v3}
  \drawvertexdof{v4}
  \drawvertexdof{v5}
  \drawvertexdof{v6}
  \drawvertexdof{v7}
  \drawvertexdof{v8}
  \drawvertexdof{v9}
  \drawvertexdof{v10}
  \drawvertexdof{v11}
  \drawvertexdof{v12}
  \drawvertexdof{v13}
  \drawvertexdof{v14}
  \drawvertexdof{v15}

  % draw a sample patch
  \tkzDefShiftPoint[v5](-.3,-.12){v5patch}
  \tkzDefShiftPoint[v9](.2,-.2){v9patch}
  \tkzDefShiftPoint[v10](.12,.3){v10patch}
  \filldraw[draw=none,fill=black,fill opacity=.15,rounded corners=8]
    (v5patch) -- (v9patch) -- (v10patch) -- cycle;

  % define arrow source
  \tkzDefPoint(1.8,1.5){src1}
\end{scope}

% data layout
\begin{scope}[xshift=4.8cm,yshift=3cm,scale=.4]
  \tkzSetUpStyle[draw=black,line width=.5]{dof}
  \tkzSetUpStyle[dof,fill=\celldofcolor]{celldof}
  \tkzSetUpStyle[dof,fill=\edgedofcolor]{edgedof}
  \tkzSetUpStyle[dof,fill=\vertdofcolor]{vertdof}

  \filldraw[vertdof] (0,0) rectangle ++ (1,1);
  \filldraw[vertdof] (1,0) rectangle ++ (1,1);
  \filldraw[vertdof] (2,0) rectangle ++ (1,1);
  \filldraw[edgedof] (3,0) rectangle ++ (1,1);
  \filldraw[edgedof] (4,0) rectangle ++ (1,1);
  \filldraw[edgedof] (5,0) rectangle ++ (1,1);
  \filldraw[edgedof] (6,0) rectangle ++ (1,1);
  \filldraw[edgedof] (7,0) rectangle ++ (1,1);
  \filldraw[edgedof] (8,0) rectangle ++ (1,1);
  \filldraw[celldof] (9,0) rectangle ++ (1,1);

  % define arrow sources
  \tkzDefPoint(0,0){src2}
  \tkzDefPoint(4.5,0){src3}
\end{scope}

% local kernel
\begin{scope}[xshift=7cm,yshift=0cm]
  \node [inner sep=0pt,at={(0,1)}] {$\int_K \nu \nabla \psi_i : \nabla \psi_j \textrm{d}\Omega$};

  % define arrow source
  \tkzDefPoint(-.8,1.1){src4}
  \tkzDefPoint(0,.8){src5}
\end{scope}

\newcommand{\drawDot}[2]{
  \node [circle,draw=#2,minimum size=1.5mm,inner sep=0,fill=#2] at #1 {};
}

\newcommand{\drawDotSmall}[2]{
  \node [circle,draw=#2,minimum size=1mm,inner sep=0,fill=#2] at #1 {};
}

\newcommand{\vertDot}[1]{\drawDot{#1}{vertdofcolor}}
\newcommand{\edgeDot}[1]{\drawDot{#1}{edgedofcolor}}
\newcommand{\cellDot}[1]{\drawDot{#1}{celldofcolor}}

\begin{scope}[xshift=5.5cm,yshift=-1.5cm,scale=.3,yscale=-1]
  \draw (0, 0) grid (10, 10);

  \foreach \x in {0,...,9} {
    \foreach \y in {0,...,9} {
      \filldraw [fill=black,draw=black] ($(\x,\y)+(.25,.25)$) rectangle ++ (.5,.5);
    }
  }

  \vertDot{(0.5,-.5)}
  \vertDot{(1.5,-.5)}
  \vertDot{(2.5,-.5)}
  \edgeDot{(3.5,-.5)}
  \edgeDot{(4.5,-.5)}
  \edgeDot{(5.5,-.5)}
  \edgeDot{(6.5,-.5)}
  \edgeDot{(7.5,-.5)}
  \edgeDot{(8.5,-.5)}
  \cellDot{(9.5,-.5)}

  \vertDot{(-.5,0.5)}
  \vertDot{(-.5,1.5)}
  \vertDot{(-.5,2.5)}
  \edgeDot{(-.5,3.5)}
  \edgeDot{(-.5,4.5)}
  \edgeDot{(-.5,5.5)}
  \edgeDot{(-.5,6.5)}
  \edgeDot{(-.5,7.5)}
  \edgeDot{(-.5,8.5)}
  \cellDot{(-.5,9.5)}

  % define arrow source
  \tkzDefPoint(5,-1){src6}
  \tkzDefPoint(-1,5){src7}
\end{scope}

\begin{scope}[xshift=0cm,yshift=-1cm,scale=.2,yscale=-1]
  \draw (0,0) grid (19,19);

  \foreach \x in {1,2,5,6,7,9,12,14,16,17} {
    \foreach \y in {1,2,5,6,7,9,12,14,16,17} {
      \filldraw [fill=black,draw=black] ($(\x,\y)+(.25,.25)$) rectangle ++ (.5,.5);
    }
  }

  \foreach \x in {1,5,9} {
    \drawDotSmall{($(\x,-.5)+(.5,0)$)}{vertdofcolor}
    \drawDotSmall{($(-.5,\x)+(0,.5)$)}{vertdofcolor}
  }

  \foreach \x in {2,6,7,12,16,17} {
    \drawDotSmall{($(\x,-.5)+(.5,0)$)}{edgedofcolor}
    \drawDotSmall{($(-.5,\x)+(0,.5)$)}{edgedofcolor}
  }

  \foreach \x in {14} {
    \drawDotSmall{($(\x,-.5)+(.5,0)$)}{celldofcolor}
    \drawDotSmall{($(-.5,\x)+(0,.5)$)}{celldofcolor}
  }

  \foreach \x in {0,...,19} { \draw (\x,19) -- (\x,20); }
  \foreach \y in {0,...,19} { \draw (19,\y) -- (20,\y); }

  % define arrow source
  \tkzDefPoint(20,10){src8}
\end{scope}

% connect images
\tkzSetUpStyle[-{stealth},shorten >=4pt,shorten <=4pt,line width=1]{connector}
\draw [connector] (src1) to (src2);
\draw [connector] (src3) to (src4);
\draw [connector] (src5) to (src6);
\draw [connector] (src7) to (src8);

\end{tikzpicture}
\end{document}
